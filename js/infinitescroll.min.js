/*!
 * Infinite Scroll for PHPMaker v24.14.0
 * Copyright (c) e.World Technology Limited. All rights reserved.
 */
!function(t,e){"use strict";function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function s(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var r=s.call(t,e||"default");if("object"!=i(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:String(e)}function r(t,e,i){return(e=s(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}let a=function(){function i(e,s){var r,a;this.container=document.getElementById(e),this.table=this.getTable(),this.table&&this.table.rows&&this.container&&this.container.classList.contains("ew-grid-middle-panel")&&(this.options=s||{},this.pageCount=s.pageCount,null!=(r=this.options).rootMargin||(r.rootMargin=i.rootMargin),null!=(a=this.options).threshold||(a.threshold=i.threshold),this.$document=t(document),this.$container=t(this.container).addClass("table-responsive"),this.$grid=this.$container.closest(".ew-grid"),this.$panels=this.$grid.find(".ew-grid-lower-panel, .ew-grid-upper-panel").innerWidth("100%"),this.$form=this.$grid.closest(".ew-form:not(.ew-list-form)"),this.$detailPages=this.$grid.closest(".ew-detail-pages").addClass("d-block"),this.$tabPane=this.$grid.closest(".tab-pane"),this.$tab=this.$detailPages.find("a[data-bs-toggle=tab][href='#"+this.$tabPane.attr("id")+"']"),this.$collapse=this.$grid.closest(".collapse"),this.isActive=this.$tab.hasClass("show")||this.$collapse.hasClass("show")||!this.$detailPages[0],this.isDetail=!!this.$form[0],this.isDetail&&!this.isActive?(this.$tab.on("shown.bs.tab",this.init.bind(this)),this.$collapse.on("shown.bs.collapse",this.init.bind(this))):this.init())}var s=i.prototype;return s.getTable=function(){var t;return null==(t=this.container)?void 0:t.querySelector("table.ew-table.ew-infinite-scroll-table")},s.getWidth=function(){return e.isMobile()?"100%":""},s.getUrl=function(t){return e.currentPage()+"?"+e.TABLE_PAGE_NUMBER+"="+t},s.getParams=function(){return new URLSearchParams([[e.TOKEN_NAME_KEY,e.TOKEN_NAME],[e.ANTIFORGERY_TOKEN_KEY,e.ANTIFORGERY_TOKEN],[e.PAGE_LAYOUT,"false"],["infinitescroll","1"]])},s.setCurrentPage=function(t){this.currentPage=t,history.replaceState(null,"",this.getUrl(t))},s.observe=function(t){this.observer||(this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting){let e=t.target;if(e.matches("tr")){let t=e.closest("tbody[data-page]");t.nextElementSibling||t.closest(".ew-grid.ew-loading")||this.load(parseInt(t.dataset.page,10))}else e.matches("tbody[data-page]")&&t.intersectionRatio>(this.options.threshold[1]||i.threshold[1])&&this.setCurrentPage(parseInt(e.dataset.page,10))}}))}),{root:this.container,rootMargin:this.options.rootMargin,threshold:this.options.threshold})),t&&this.observer.observe(t)},s.observeTableBody=function(t){this.observe(t);let e=Math.max(i.countToLast,1)||1;for(let i=1;i<=e;i++)this.observe(t.querySelector(":scope > tr:nth-last-child("+i+")"))},s.load=function(s){if(s>=this.pageCount)return;if(this.$grid.find("[data-rowtype="+e.ROWTYPE_ADD+"], [data-rowtype="+e.ROWTYPE_EDIT+"]")[0])return;let r=t(e.overlayTemplate());this.$grid.addClass("ew-loading").append(r),fetch(this.getUrl(++s),{method:"POST",body:this.getParams()}).then((async s=>{let r=t("<div>"+await s.text()+"</div>"),a=r.find(".list")[0],n=r.find(".ew-infinite-scroll-table > tbody[data-page]")[0];if(n){i.replaceSelectors.forEach((e=>t(e).html(r.find(e).html()))),i.appendSelectors.forEach((e=>t(e).append(r.find(e).html())));let s=t.Event({type:"load.ew",target:a});this.table.appendChild(n),e.initPage(s),this.$document.trigger(s),Array.from(this.table.rows).forEach(((t,e)=>t.dataset.rowindex=e)),this.observeTableBody(n)}})).finally((()=>this.$grid.removeClass("ew-loading").find(r).remove()))},s.setupTable=function(){if(this.table=this.getTable(),e.setupTable(this.table),this.table.rows&&this.container.clientHeight>this.table.offsetHeight){let e=t(this.table.rows).filter(":not(.ew-template)"),i=e.filter("[data-rowindex=1]").length||e.filter("[data-rowindex=0]").length||1;e.slice(-1*i).find("td.ew-table-last-row").removeClass("ew-table-last-row").addClass("ew-table-border-bottom")}let i=this.table.querySelector("tbody[data-page]");!i||this.observeTableBody(i)},s.init=function(){if(this.$container.data("InfiniteScroll"))return;t(document).on("ajaxSend",(function(i,s,r){let a=r.data;if(t.isString(a)&&a.startsWith("[{")&&a.endsWith("}]")){let t=e.parseJson(a);Array.isArray(t)&&(r.data=JSON.stringify(t.map((t=>({...t,infinitescroll:1})))))}else r.multipart&&(r.contentType="multipart/form-data"),r.data instanceof FormData?r.data.set("infinitescroll","1"):r.data=e.mergeSearchParams(a,{infinitescroll:1})})),t(document).on("fetch",(function(t,i){null!=i.init||(i.init={}),!i.init.method||e.sameText(i.init.method,"GET")?i.url=e.setSearchParams(i.url,{infinitescroll:1}):i.init.body instanceof FormData?i.init.body.set("infinitescroll","1"):i.init.body=e.mergeSearchParams(i.init.body,{infinitescroll:1})}));let i=this.getWidth();this.isDetail&&i&&this.$form.addClass("w-100"),(this.isDetail||e.isMobile())&&this.$grid.addClass("d-block"),this.setupTable(),this.$document.on("refresh.ew",(t=>{let e=t.target;if(this.$grid[0]==e){e.querySelector(".ew-grid-middle-panel").scrollTop=0,this.setupTable()}})),this.$container.data("InfiniteScroll",this)},i}();r(a,"countToLast",1),r(a,"rootMargin","0px"),r(a,"threshold",[0,.25]),r(a,"replaceSelectors",[".ew-infinite-scroll-grid .ew-grid-upper-panel .ew-pager-end",".ew-infinite-scroll-table thead",".ew-infinite-scroll-grid .ew-grid-lower-panel .ew-pager-end"]),r(a,"appendSelectors",[".ew-debug .card-body"]),Object.assign(e,{InfiniteScroll:a})}(jQuery,ew);
//# sourceMappingURL=infinitescroll.min.js.map